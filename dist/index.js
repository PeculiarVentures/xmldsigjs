'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var pkijs=require('pkijs'),XmlCore=require('xml-core'),tslib_1=require('tslib'),Asn1Js=require('asn1js'),engineCrypto=null,Application=function(){function e(){}return e.setEngine=function(e,t){engineCrypto={getRandomValues:t.getRandomValues.bind(t),subtle:t.subtle,name:e},pkijs.setEngine(e,new pkijs.CryptoEngine({name:e,crypto:t,subtle:t.subtle}),new pkijs.CryptoEngine({name:e,crypto:t,subtle:t.subtle}))},Object.defineProperty(e,'crypto',{get:function e(){if(!engineCrypto)throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC_NO_MODULE);return engineCrypto},enumerable:!0,configurable:!0}),e.isNodePlugin=function(){return'undefined'==typeof self&&'undefined'==typeof window},e}();function init(){Application.isNodePlugin()||Application.setEngine('W3 WebCrypto module',self.crypto)}init(),function(e){e[e.BeforeDocElement=0]='BeforeDocElement',e[e.InsideDocElement=1]='InsideDocElement',e[e.AfterDocElement=2]='AfterDocElement'}(exports.XmlCanonicalizerState||(exports.XmlCanonicalizerState={}));var XmlCanonicalizer=function(){function e(e,t,r){void 0===r&&(r=new XmlCore.NamespaceManager),this.propagatedNamespaces=new XmlCore.NamespaceManager,this.result=[],this.visibleNamespaces=new XmlCore.NamespaceManager,this.inclusiveNamespacesPrefixList=[],this.state=exports.XmlCanonicalizerState.BeforeDocElement,this.withComments=e,this.exclusive=t,this.propagatedNamespaces=r}return Object.defineProperty(e.prototype,'InclusiveNamespacesPrefixList',{get:function e(){return this.inclusiveNamespacesPrefixList.join(' ')},set:function t(e){this.inclusiveNamespacesPrefixList=e.split(' ')},enumerable:!0,configurable:!0}),e.prototype.Canonicalize=function(e){if(!e)throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Parameter 1 is not Node');var t;e.nodeType===XmlCore.XmlNodeType.Document?(this.document=e,t=this.document.documentElement):(this.document=e.ownerDocument,t=e),this.WriteNode(t);var r=this.result.join('');return r},e.prototype.WriteNode=function(e){switch(e.nodeType){case XmlCore.XmlNodeType.Document:case XmlCore.XmlNodeType.DocumentFragment:this.WriteDocumentNode(e);break;case XmlCore.XmlNodeType.Element:this.WriteElementNode(e);break;case XmlCore.XmlNodeType.CDATA:case XmlCore.XmlNodeType.SignificantWhitespace:case XmlCore.XmlNodeType.Text:this.WriteTextNode(e);break;case XmlCore.XmlNodeType.Whitespace:this.state===exports.XmlCanonicalizerState.InsideDocElement&&this.WriteTextNode(e);break;case XmlCore.XmlNodeType.Comment:this.WriteCommentNode(e);break;case XmlCore.XmlNodeType.ProcessingInstruction:this.WriteProcessingInstructionNode(e);break;case XmlCore.XmlNodeType.EntityReference:for(var t=0;t<e.childNodes.length;t++)this.WriteNode(e.childNodes[t]);break;case XmlCore.XmlNodeType.Attribute:throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Attribute node is impossible here');case XmlCore.XmlNodeType.EndElement:throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Attribute node is impossible here');case XmlCore.XmlNodeType.EndEntity:throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Attribute node is impossible here');case XmlCore.XmlNodeType.DocumentType:case XmlCore.XmlNodeType.Entity:case XmlCore.XmlNodeType.Notation:case XmlCore.XmlNodeType.XmlDeclaration:}},e.prototype.WriteDocumentNode=function(e){this.state=exports.XmlCanonicalizerState.BeforeDocElement;for(var t=e.firstChild;null!=t;t=t.nextSibling)this.WriteNode(t)},e.prototype.WriteCommentNode=function(e){var t=String.fromCharCode;this.withComments&&(this.state===exports.XmlCanonicalizerState.AfterDocElement?this.result.push(t(10)+'<!--'):this.result.push('<!--'),this.result.push(this.NormalizeString(e.nodeValue,XmlCore.XmlNodeType.Comment)),this.state===exports.XmlCanonicalizerState.BeforeDocElement?this.result.push('-->'+t(10)):this.result.push('-->'))},e.prototype.WriteTextNode=function(e){this.result.push(this.NormalizeString(e.nodeValue,e.nodeType))},e.prototype.WriteProcessingInstructionNode=function(e){this.state===exports.XmlCanonicalizerState.AfterDocElement?this.result.push('\n<?'):this.result.push('<?'),this.result.push(e.nodeName),e.nodeValue&&(this.result.push(' '),this.result.push(this.NormalizeString(e.nodeValue,XmlCore.XmlNodeType.ProcessingInstruction))),this.state===exports.XmlCanonicalizerState.BeforeDocElement?this.result.push('?>\n'):this.result.push('?>')},e.prototype.WriteElementNode=function(e){this.state===exports.XmlCanonicalizerState.BeforeDocElement&&(this.state=exports.XmlCanonicalizerState.InsideDocElement),this.result.push('<'),this.result.push(e.nodeName);var t=this.WriteNamespacesAxis(e);this.WriteAttributesAxis(e),this.result.push('>');for(var r=e.firstChild;null!=r;r=r.nextSibling)this.WriteNode(r);for(this.result.push('</'),this.result.push(e.nodeName),this.result.push('>'),this.state===exports.XmlCanonicalizerState.BeforeDocElement&&(this.state=exports.XmlCanonicalizerState.AfterDocElement);t--;)this.visibleNamespaces.Pop()},e.prototype.WriteNamespacesAxis=function(e){for(var t,r=this,a=[],n=0,o=0;o<e.attributes.length;o++){if(t=e.attributes[o],!IsNamespaceNode(t)){if(t.prefix&&!this.IsNamespaceRendered(t.prefix,t.namespaceURI)){var l={prefix:t.prefix,namespace:t.namespaceURI};a.push(l),this.visibleNamespaces.Add(l),n++}continue}if('xmlns'===t.localName&&!t.prefix&&!t.nodeValue){var l={prefix:t.prefix,namespace:t.nodeValue};a.push(l),this.visibleNamespaces.Add(l),n++}var m=null,s=void 0;(s=/xmlns:([\w\.]+)/.exec(t.nodeName))&&(m=s[1]);var p=!0;if(this.exclusive&&!this.IsNamespaceInclusive(e,m)){var d=IsNamespaceUsed(e,m);if(1<d)p=!1;else if(0===d)continue}if(!this.IsNamespaceRendered(m,t.nodeValue)&&p){var l={prefix:m,namespace:t.nodeValue};a.push(l),this.visibleNamespaces.Add(l),n++}}if(!this.IsNamespaceRendered(e.prefix,e.namespaceURI)&&'http://www.w3.org/2000/xmlns/'!==e.namespaceURI){var l={prefix:e.prefix,namespace:e.namespaceURI};a.push(l),this.visibleNamespaces.Add(l),n++}a.sort(XmlDsigC14NTransformNamespacesComparer);var u=null;return a.forEach(function(e){e.prefix===u||(u=e.prefix,r.result.push(' xmlns'),e.prefix&&r.result.push(':'+e.prefix),r.result.push('="'),r.result.push(e.namespace),r.result.push('"'))}),n},e.prototype.WriteAttributesAxis=function(e){for(var t,r=this,a=[],n=0;n<e.attributes.length;n++)t=e.attributes[n],IsNamespaceNode(t)||a.push(t);a.sort(XmlDsigC14NTransformAttributesComparer),a.forEach(function(e){null!=e&&(r.result.push(' '),r.result.push(e.nodeName),r.result.push('="'),r.result.push(r.NormalizeString(e.nodeValue,XmlCore.XmlNodeType.Attribute)),r.result.push('"'))})},e.prototype.NormalizeString=function(e,t){var r=[];if(e)for(var a,n=0;n<e.length;n++)a=e[n],'<'===a&&(t===XmlCore.XmlNodeType.Attribute||this.IsTextNode(t))?r.push('&lt;'):'>'===a&&this.IsTextNode(t)?r.push('&gt;'):'&'===a&&(t===XmlCore.XmlNodeType.Attribute||this.IsTextNode(t))?r.push('&amp;'):'"'===a&&t===XmlCore.XmlNodeType.Attribute?r.push('&quot;'):'\t'===a&&t===XmlCore.XmlNodeType.Attribute?r.push('&#x9;'):'\n'===a&&t===XmlCore.XmlNodeType.Attribute?r.push('&#xA;'):'\r'===a?r.push('&#xD;'):r.push(a);return r.join('')},e.prototype.IsTextNode=function(e){return e===XmlCore.XmlNodeType.Text||e===XmlCore.XmlNodeType.CDATA||e===XmlCore.XmlNodeType.SignificantWhitespace||e===XmlCore.XmlNodeType.Whitespace},e.prototype.IsNamespaceInclusive=function(e,t){var r=t||null;return e.prefix!==r&&-1!==this.inclusiveNamespacesPrefixList.indexOf(r||'')},e.prototype.IsNamespaceRendered=function(e,t){if(e=e||'',t=t||'',!e&&!t)return!0;if('xml'===e&&'http://www.w3.org/XML/1998/namespace'===t)return!0;var r=this.visibleNamespaces.GetPrefix(e);return!!r&&r.namespace===t},e}();function XmlDsigC14NTransformNamespacesComparer(e,t){if(e==t)return 0;return e?t?e.prefix?t.prefix?e.prefix.localeCompare(t.prefix):1:-1:1:-1}function XmlDsigC14NTransformAttributesComparer(e,t){if(!e.namespaceURI&&t.namespaceURI)return-1;if(!t.namespaceURI&&e.namespaceURI)return 1;var r=e.namespaceURI+e.localName,a=t.namespaceURI+t.localName;return r===a?0:r<a?-1:1}function IsNamespaceUsed(e,t,r){void 0===r&&(r=0);if(e.prefix===(t||null))return++r;if(e.attributes)for(var a,o=0;o<e.attributes.length;o++)if(a=e.attributes[o],!IsNamespaceNode(a)&&t&&e.attributes[o].prefix===t)return++r;for(var l=e.firstChild;!!l;l=l.nextSibling)if(l.nodeType===XmlCore.XmlNodeType.Element){var m=l,s=IsNamespaceUsed(m,t,r);if(l.nodeType===XmlCore.XmlNodeType.Element&&s)return++r+s}return r}function IsNamespaceNode(e){var t=/xmlns:/;return!!(null!==e&&e.nodeType===XmlCore.XmlNodeType.Attribute&&('xmlns'===e.nodeName||t.test(e.nodeName)))}var XmlSignature={DefaultCanonMethod:'http://www.w3.org/TR/2001/REC-xml-c14n-20010315',DefaultDigestMethod:'http://www.w3.org/2001/04/xmlenc#sha256',DefaultPrefix:' ',ElementNames:{CanonicalizationMethod:'CanonicalizationMethod',DigestMethod:'DigestMethod',DigestValue:'DigestValue',DSAKeyValue:'DSAKeyValue',DomainParameters:'DomainParameters',EncryptedKey:'EncryptedKey',HMACOutputLength:'HMACOutputLength',RSAPSSParams:'RSAPSSParams',MaskGenerationFunction:'MaskGenerationFunction',SaltLength:'SaltLength',KeyInfo:'KeyInfo',KeyName:'KeyName',KeyValue:'KeyValue',Modulus:'Modulus',Exponent:'Exponent',Manifest:'Manifest',Object:'Object',Reference:'Reference',RetrievalMethod:'RetrievalMethod',RSAKeyValue:'RSAKeyValue',ECDSAKeyValue:'ECDSAKeyValue',NamedCurve:'NamedCurve',PublicKey:'PublicKey',Signature:'Signature',SignatureMethod:'SignatureMethod',SignatureValue:'SignatureValue',SignedInfo:'SignedInfo',Transform:'Transform',Transforms:'Transforms',X509Data:'X509Data',PGPData:'PGPData',SPKIData:'SPKIData',SPKIexp:'SPKIexp',MgmtData:'MgmtData',X509IssuerSerial:'X509IssuerSerial',X509IssuerName:'X509IssuerName',X509SerialNumber:'X509SerialNumber',X509SKI:'X509SKI',X509SubjectName:'X509SubjectName',X509Certificate:'X509Certificate',X509CRL:'X509CRL',XPath:'XPath',X:'X',Y:'Y'},AttributeNames:{Algorithm:'Algorithm',Encoding:'Encoding',Id:'Id',MimeType:'MimeType',Type:'Type',URI:'URI',Filter:'Filter'},AlgorithmNamespaces:{XmlDsigBase64Transform:'http://www.w3.org/2000/09/xmldsig#base64',XmlDsigC14NTransform:'http://www.w3.org/TR/2001/REC-xml-c14n-20010315',XmlDsigC14NWithCommentsTransform:'http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments',XmlDsigEnvelopedSignatureTransform:'http://www.w3.org/2000/09/xmldsig#enveloped-signature',XmlDsigXPathTransform:'http://www.w3.org/TR/1999/REC-xpath-19991116',XmlDsigXsltTransform:'http://www.w3.org/TR/1999/REC-xslt-19991116',XmlDsigExcC14NTransform:'http://www.w3.org/2001/10/xml-exc-c14n#',XmlDsigExcC14NWithCommentsTransform:'http://www.w3.org/2001/10/xml-exc-c14n#WithComments',XmlDecryptionTransform:'http://www.w3.org/2002/07/decrypt#XML',XmlLicenseTransform:'urn:mpeg:mpeg21:2003:01-REL-R-NS:licenseTransform',XmlDsigFilterTransform:'http://www.w3.org/2002/06/xmldsig-filter2'},Uri:{Manifest:'http://www.w3.org/2000/09/xmldsig#Manifest'},NamespaceURI:'http://www.w3.org/2000/09/xmldsig#',NamespaceURIMore:'http://www.w3.org/2007/05/xmldsig-more#',NamespaceURIPss:'http://www.example.org/xmldsig-pss/#'},XmlSignatureObject=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t=tslib_1.__decorate([XmlCore.XmlElement({localName:'xmldsig',namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix})],t),t}(XmlCore.XmlObject),XmlSignatureCollection=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t=tslib_1.__decorate([XmlCore.XmlElement({localName:'xmldsig_collection',namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix})],t),t}(XmlCore.XmlCollection),KeyInfoClause=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t}(XmlSignatureObject),XmlAlgorithm=function(){function e(){}return e.prototype.getAlgorithmName=function(){return this.namespaceURI},e}(),HashAlgorithm=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.prototype.Digest=function(e){var t=this;return Promise.resolve().then(function(){var r;if('string'==typeof e)r=XmlCore.Convert.FromString(e,'utf8');else if(ArrayBuffer.isView(e)||e instanceof ArrayBuffer)r=e;else{var a=new XMLSerializer().serializeToString(e);r=XmlCore.Convert.FromString(a,'utf8')}return Application.crypto.subtle.digest(t.algorithm,r)}).then(function(e){return new Uint8Array(e)})},t}(XmlAlgorithm),SignatureAlgorithm=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.prototype.Sign=function(e,t,r){var a=XmlCore.Convert.FromString(e,'utf8');return Application.crypto.subtle.sign(r,t,a)},t.prototype.Verify=function(e,t,r,a){var n=XmlCore.Convert.FromString(e,'utf8');return Application.crypto.subtle.verify(a||this.algorithm,t,r,n)},t}(XmlAlgorithm),SHA1='SHA-1',SHA256='SHA-256',SHA384='SHA-384',SHA512='SHA-512',SHA1_NAMESPACE='http://www.w3.org/2000/09/xmldsig#sha1',SHA256_NAMESPACE='http://www.w3.org/2001/04/xmlenc#sha256',SHA384_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#sha384',SHA512_NAMESPACE='http://www.w3.org/2001/04/xmlenc#sha512',Sha1=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:SHA1},t.namespaceURI=SHA1_NAMESPACE,t}return tslib_1.__extends(t,e),t}(HashAlgorithm),Sha256=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:SHA256},t.namespaceURI=SHA256_NAMESPACE,t}return tslib_1.__extends(t,e),t}(HashAlgorithm),Sha384=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:SHA384},t.namespaceURI=SHA384_NAMESPACE,t}return tslib_1.__extends(t,e),t}(HashAlgorithm),Sha512=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:SHA512},t.namespaceURI=SHA512_NAMESPACE,t}return tslib_1.__extends(t,e),t}(HashAlgorithm),ECDSA='ECDSA',ECDSA_SHA1_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha1',ECDSA_SHA256_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256',ECDSA_SHA384_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha384',ECDSA_SHA512_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha512',EcdsaSha1=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:ECDSA,hash:{name:SHA1}},t.namespaceURI=ECDSA_SHA1_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),EcdsaSha256=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:ECDSA,hash:{name:SHA256}},t.namespaceURI=ECDSA_SHA256_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),EcdsaSha384=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:ECDSA,hash:{name:SHA384}},t.namespaceURI=ECDSA_SHA384_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),EcdsaSha512=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:ECDSA,hash:{name:SHA512}},t.namespaceURI=ECDSA_SHA512_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),HMAC='HMAC',HMAC_SHA1_NAMESPACE='http://www.w3.org/2000/09/xmldsig#hmac-sha1',HMAC_SHA256_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#hmac-sha256',HMAC_SHA384_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#hmac-sha384',HMAC_SHA512_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#hmac-sha512',HmacSha1=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:HMAC,hash:{name:SHA1}},t.namespaceURI=HMAC_SHA1_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),HmacSha256=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:HMAC,hash:{name:SHA256}},t.namespaceURI=HMAC_SHA256_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),HmacSha384=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:HMAC,hash:{name:SHA384}},t.namespaceURI=HMAC_SHA384_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),HmacSha512=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:HMAC,hash:{name:SHA512}},t.namespaceURI=HMAC_SHA512_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),RSA_PKCS1='RSASSA-PKCS1-v1_5',RSA_PKCS1_SHA1_NAMESPACE='http://www.w3.org/2000/09/xmldsig#rsa-sha1',RSA_PKCS1_SHA256_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#rsa-sha256',RSA_PKCS1_SHA384_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#rsa-sha384',RSA_PKCS1_SHA512_NAMESPACE='http://www.w3.org/2001/04/xmldsig-more#rsa-sha512',RsaPkcs1Sha1=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:RSA_PKCS1,hash:{name:SHA1}},t.namespaceURI=RSA_PKCS1_SHA1_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),RsaPkcs1Sha256=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:RSA_PKCS1,hash:{name:SHA256}},t.namespaceURI=RSA_PKCS1_SHA256_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),RsaPkcs1Sha384=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:RSA_PKCS1,hash:{name:SHA384}},t.namespaceURI=RSA_PKCS1_SHA384_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),RsaPkcs1Sha512=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.algorithm={name:RSA_PKCS1,hash:{name:SHA512}},t.namespaceURI=RSA_PKCS1_SHA512_NAMESPACE,t}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),RSA_PSS='RSA-PSS',RSA_PSS_WITH_PARAMS_NAMESPACE='http://www.w3.org/2007/05/xmldsig-more#rsa-pss',RsaPssBase=function(e){function t(t){var r=e.call(this)||this;return r.algorithm={name:RSA_PSS,hash:{name:SHA1}},r.namespaceURI=RSA_PSS_WITH_PARAMS_NAMESPACE,t&&(r.algorithm.saltLength=t),r}return tslib_1.__extends(t,e),t}(SignatureAlgorithm),RsaPssSha1=function(e){function t(t){var r=e.call(this,t)||this;return r.algorithm.hash.name=SHA1,r}return tslib_1.__extends(t,e),t}(RsaPssBase),RsaPssSha256=function(e){function t(t){var r=e.call(this,t)||this;return r.algorithm.hash.name=SHA256,r}return tslib_1.__extends(t,e),t}(RsaPssBase),RsaPssSha384=function(e){function t(t){var r=e.call(this,t)||this;return r.algorithm.hash.name=SHA384,r}return tslib_1.__extends(t,e),t}(RsaPssBase),RsaPssSha512=function(e){function t(t){var r=e.call(this,t)||this;return r.algorithm.hash.name=SHA512,r}return tslib_1.__extends(t,e),t}(RsaPssBase),CanonicalizationMethod=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Algorithm,required:!0,defaultValue:XmlSignature.DefaultCanonMethod})],t.prototype,'Algorithm',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.CanonicalizationMethod})],t),t}(XmlSignatureObject),DataObject=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Id,defaultValue:''})],t.prototype,'Id',void 0),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.MimeType,defaultValue:''})],t.prototype,'MimeType',void 0),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Encoding,defaultValue:''})],t.prototype,'Encoding',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.Object})],t),t}(XmlSignatureObject),DataObjects=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t=tslib_1.__decorate([XmlCore.XmlElement({localName:'xmldsig_objects',parser:DataObject})],t),t}(XmlSignatureCollection),DigestMethod=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Algorithm,required:!0,defaultValue:XmlSignature.DefaultDigestMethod})],t.prototype,'Algorithm',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.DigestMethod})],t),t}(XmlSignatureObject),KeyInfo=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.prototype.OnLoadXml=function(e){for(var t=function(t){var a=e.childNodes.item(t);if(a.nodeType!==XmlCore.XmlNodeType.Element)return'continue';var n=null;switch(a.localName){case XmlSignature.ElementNames.KeyValue:n=KeyValue;break;case XmlSignature.ElementNames.X509Data:n=KeyInfoX509Data;break;case XmlSignature.ElementNames.SPKIData:n=SPKIData;break;case XmlSignature.ElementNames.KeyName:case XmlSignature.ElementNames.RetrievalMethod:case XmlSignature.ElementNames.PGPData:case XmlSignature.ElementNames.MgmtData:}if(n){var o=new n;if(o.LoadXml(a),o instanceof KeyValue){var l=null;if([RsaKeyValue,EcdsaKeyValue].some(function(e){try{for(var t,r=new e,n=0;n<a.childNodes.length;n++)if(t=a.childNodes.item(n),t.nodeType===XmlCore.XmlNodeType.Element)return r.LoadXml(t),l=r,!0}catch(t){}return!1}),l)o.Value=l;else throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Unsupported KeyValue in use');o.GetXml()}r.Add(o)}},r=this,a=0;a<e.childNodes.length;a++)t(a)},tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Id,defaultValue:''})],t.prototype,'Id',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.KeyInfo})],t),t}(XmlSignatureCollection),Transform=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.innerXml=null,t}return tslib_1.__extends(t,e),t.prototype.GetOutput=function(){throw new XmlCore.XmlError(XmlCore.XE.METHOD_NOT_IMPLEMENTED)},t.prototype.LoadInnerXml=function(e){if(!e)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'node');this.innerXml=e},t.prototype.GetInnerXml=function(){return this.innerXml},tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Algorithm,defaultValue:''})],t.prototype,'Algorithm',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.XPath,defaultValue:''})],t.prototype,'XPath',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.Transform})],t),t}(XmlSignatureObject),XmlDsigBase64Transform=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.Algorithm=XmlSignature.AlgorithmNamespaces.XmlDsigBase64Transform,t}return tslib_1.__extends(t,e),t.prototype.GetOutput=function(){if(!this.innerXml)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'innerXml');return XmlCore.Convert.FromString(this.innerXml.textContent||'','base64')},t}(Transform),XmlDsigC14NTransform=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.Algorithm='http://www.w3.org/TR/2001/REC-xml-c14n-20010315',t.xmlCanonicalizer=new XmlCanonicalizer(!1,!1),t}return tslib_1.__extends(t,e),t.prototype.GetOutput=function(){if(!this.innerXml)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'innerXml');return this.xmlCanonicalizer.Canonicalize(this.innerXml)},t}(Transform),XmlDsigC14NWithCommentsTransform=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.Algorithm='http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments',t.xmlCanonicalizer=new XmlCanonicalizer(!0,!1),t}return tslib_1.__extends(t,e),t}(XmlDsigC14NTransform),XmlDsigEnvelopedSignatureTransform=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.Algorithm='http://www.w3.org/2000/09/xmldsig#enveloped-signature',t}return tslib_1.__extends(t,e),t.prototype.GetOutput=function(){if(!this.innerXml)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'innerXml');var e=XmlCore.Select(this.innerXml,'.//*[local-name(.)=\'Signature\' and namespace-uri(.)=\'http://www.w3.org/2000/09/xmldsig#\']')[0];return e&&e.parentNode.removeChild(e),this.innerXml},t}(Transform),XmlDsigExcC14NTransform=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.Algorithm='http://www.w3.org/2001/10/xml-exc-c14n#',t.xmlCanonicalizer=new XmlCanonicalizer(!1,!0),t}return tslib_1.__extends(t,e),Object.defineProperty(t.prototype,'InclusiveNamespacesPrefixList',{get:function e(){return this.xmlCanonicalizer.InclusiveNamespacesPrefixList},set:function t(e){this.xmlCanonicalizer.InclusiveNamespacesPrefixList=e},enumerable:!0,configurable:!0}),t.prototype.GetOutput=function(){if(!this.innerXml)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'innerXml');return this.xmlCanonicalizer.Canonicalize(this.innerXml)},t}(Transform),XmlDsigExcC14NWithCommentsTransform=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.Algorithm='http://www.w3.org/2001/10/xml-exc-c14n#WithComments',t.xmlCanonicalizer=new XmlCanonicalizer(!0,!0),t}return tslib_1.__extends(t,e),t}(XmlDsigExcC14NTransform),XPathDisplayFilterObject=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Filter,required:!0})],t.prototype,'Filter',void 0),tslib_1.__decorate([XmlCore.XmlContent({required:!0})],t.prototype,'XPath',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.XPath,prefix:'',namespaceURI:'http://www.w3.org/2002/06/xmldsig-filter2'})],t),t}(XmlSignatureObject),XmlDsigDisplayFilterTransform=function(e){function t(t){var r=e.call(this)||this;if(r.Algorithm='http://www.w3.org/2002/06/xmldsig-filter2',null==t)throw Error('params is undefined');return r.XPathFilter=new XPathDisplayFilterObject,r.XPathFilter.Prefix='',r.XPathFilter.XPath=t.XPath,r.XPathFilter.Filter=t.Filter,r}return tslib_1.__extends(t,e),t.prototype.GetOutput=function(){if(!this.innerXml)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'innerXml');return this.innerXml},tslib_1.__decorate([XmlCore.XmlChildElement({localName:'XPath',required:!0,parser:XPathDisplayFilterObject,prefix:'',namespaceURI:XmlSignature.NamespaceURI})],t.prototype,'XPathFilter',void 0),t}(Transform),Transforms=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.prototype.OnLoadXml=function(t){e.prototype.OnLoadXml.call(this,t),this.items=this.GetIterator().map(function(e){switch(e.Algorithm){case XmlSignature.AlgorithmNamespaces.XmlDsigEnvelopedSignatureTransform:return ChangeTransform(e,XmlDsigEnvelopedSignatureTransform);case XmlSignature.AlgorithmNamespaces.XmlDsigC14NTransform:return ChangeTransform(e,XmlDsigC14NTransform);case XmlSignature.AlgorithmNamespaces.XmlDsigC14NWithCommentsTransform:return ChangeTransform(e,XmlDsigC14NWithCommentsTransform);case XmlSignature.AlgorithmNamespaces.XmlDsigExcC14NTransform:return ChangeTransform(e,XmlDsigExcC14NTransform);case XmlSignature.AlgorithmNamespaces.XmlDsigExcC14NWithCommentsTransform:return ChangeTransform(e,XmlDsigExcC14NWithCommentsTransform);case XmlSignature.AlgorithmNamespaces.XmlDsigBase64Transform:return ChangeTransform(e,XmlDsigBase64Transform);case XmlSignature.AlgorithmNamespaces.XmlDsigFilterTransform:return ChangeTransform(e,XmlDsigDisplayFilterTransform);default:throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC_UNKNOWN_TRANSFORM,e.Algorithm);}})},t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.Transforms,parser:Transform})],t),t}(XmlSignatureCollection);function ChangeTransform(e,r){var a=new r;return a.element=e.Element,a}var Reference=function(e){function t(t){var r=e.call(this)||this;return t&&(r.Uri=t),r}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({defaultValue:''})],t.prototype,'Id',void 0),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.URI})],t.prototype,'Uri',void 0),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Type,defaultValue:''})],t.prototype,'Type',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:Transforms})],t.prototype,'Transforms',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({required:!0,parser:DigestMethod})],t.prototype,'DigestMethod',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({required:!0,localName:XmlSignature.ElementNames.DigestValue,namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix,converter:XmlCore.XmlBase64Converter})],t.prototype,'DigestValue',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.Reference})],t),t}(XmlSignatureObject),References=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t=tslib_1.__decorate([XmlCore.XmlElement({localName:'References',parser:Reference})],t),t}(XmlSignatureCollection),SignatureMethodOther=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.prototype.OnLoadXml=function(e){for(var t,r=0;r<e.childNodes.length;r++)if(t=e.childNodes.item(r),t.nodeType===XmlCore.XmlNodeType.Element&&t.nodeName!==XmlSignature.ElementNames.HMACOutputLength){var a=void 0;switch(t.localName){case XmlSignature.ElementNames.RSAPSSParams:a=PssAlgorithmParams;break;default:}if(a){var n=new a;n.LoadXml(t),this.Add(n)}}},t=tslib_1.__decorate([XmlCore.XmlElement({localName:'Other'})],t),t}(XmlSignatureCollection),SignatureMethod=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Algorithm,required:!0,defaultValue:''})],t.prototype,'Algorithm',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.HMACOutputLength,namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix,converter:XmlCore.XmlNumberConverter})],t.prototype,'HMACOutputLength',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:SignatureMethodOther,noRoot:!0,minOccurs:0})],t.prototype,'Any',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.SignatureMethod})],t),t}(XmlSignatureObject),SignedInfo=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Id,defaultValue:''})],t.prototype,'Id',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:CanonicalizationMethod,required:!0})],t.prototype,'CanonicalizationMethod',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:SignatureMethod,required:!0})],t.prototype,'SignatureMethod',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:References,minOccurs:1,noRoot:!0})],t.prototype,'References',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.SignedInfo})],t),t}(XmlSignatureObject),Signature=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Id,defaultValue:''})],t.prototype,'Id',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:SignedInfo,required:!0})],t.prototype,'SignedInfo',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.SignatureValue,namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix,required:!0,converter:XmlCore.XmlBase64Converter,defaultValue:null})],t.prototype,'SignatureValue',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:KeyInfo})],t.prototype,'KeyInfo',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:DataObjects,noRoot:!0})],t.prototype,'ObjectList',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.Signature})],t),t}(XmlSignatureObject),NAMESPACE_URI='http://www.w3.org/2001/04/xmldsig-more#',PREFIX='ecdsa',EcdsaPublicKey=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.X,namespaceURI:NAMESPACE_URI,prefix:PREFIX,required:!0,converter:XmlCore.XmlBase64Converter})],t.prototype,'X',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.Y,namespaceURI:NAMESPACE_URI,prefix:PREFIX,required:!0,converter:XmlCore.XmlBase64Converter})],t.prototype,'Y',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.PublicKey,namespaceURI:NAMESPACE_URI,prefix:PREFIX})],t),t}(XmlCore.XmlObject),NamedCurve=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.URI,required:!0})],t.prototype,'Uri',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.NamedCurve,namespaceURI:NAMESPACE_URI,prefix:PREFIX})],t),t}(XmlCore.XmlObject),DomainParameters=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlChildElement({parser:NamedCurve})],t.prototype,'NamedCurve',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.DomainParameters,namespaceURI:NAMESPACE_URI,prefix:PREFIX})],t),t}(XmlCore.XmlObject),EcdsaKeyValue=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name=XmlSignature.ElementNames.ECDSAKeyValue,t.key=null,t.jwk=null,t.keyUsage=null,t}return tslib_1.__extends(t,e),Object.defineProperty(t.prototype,'NamedCurve',{get:function e(){return GetNamedCurveOid(this.DomainParameters.NamedCurve.Uri)},enumerable:!0,configurable:!0}),t.prototype.importKey=function(e){var t=this;return new Promise(function(r,a){if('ECDSA'!==e.algorithm.name.toUpperCase())throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_WRONG_NAME,e.algorithm.name);t.key=e,Application.crypto.subtle.exportKey('jwk',e).then(function(r){return t.jwk=r,t.PublicKey=new EcdsaPublicKey,t.PublicKey.X=XmlCore.Convert.FromString(r.x,'base64url'),t.PublicKey.Y=XmlCore.Convert.FromString(r.y,'base64url'),t.DomainParameters||(t.DomainParameters=new DomainParameters),t.DomainParameters.NamedCurve||(t.DomainParameters.NamedCurve=new NamedCurve),t.DomainParameters.NamedCurve.Uri=GetNamedCurveOid(r.crv),t.keyUsage=e.usages,Promise.resolve(t)}).then(r,a)})},t.prototype.exportKey=function(){var e=this;return Promise.resolve().then(function(){if(e.key)return e.key;var t=XmlCore.Convert.ToBase64Url(e.PublicKey.X),r=XmlCore.Convert.ToBase64Url(e.PublicKey.Y),a=GetNamedCurveFromOid(e.DomainParameters.NamedCurve.Uri);return e.keyUsage=['verify'],Application.crypto.subtle.importKey('jwk',{kty:'EC',crv:a,x:t,y:r,ext:!0},{name:'ECDSA',namedCurve:a},!0,e.keyUsage)}).then(function(t){return e.key=t,e.key})},tslib_1.__decorate([XmlCore.XmlChildElement({parser:DomainParameters})],t.prototype,'DomainParameters',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:EcdsaPublicKey,required:!0})],t.prototype,'PublicKey',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.ECDSAKeyValue,namespaceURI:NAMESPACE_URI,prefix:PREFIX})],t),t}(KeyInfoClause);function GetNamedCurveOid(e){switch(e){case'P-256':return'urn:oid:1.2.840.10045.3.1.7';case'P-384':return'urn:oid:1.3.132.0.34';case'P-521':return'urn:oid:1.3.132.0.35';}throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Unknown NamedCurve')}function GetNamedCurveFromOid(e){switch(e){case'urn:oid:1.2.840.10045.3.1.7':return'P-256';case'urn:oid:1.3.132.0.34':return'P-384';case'urn:oid:1.3.132.0.35':return'P-521';}throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Unknown NamedCurve OID')}var RsaKeyValue=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.key=null,t.jwk=null,t.keyUsage=[],t}return tslib_1.__extends(t,e),t.prototype.importKey=function(e){var t=this;return new Promise(function(r,a){var n=e.algorithm.name.toUpperCase();if(n!==RSA_PKCS1.toUpperCase()&&n!==RSA_PSS.toUpperCase())throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_WRONG_NAME,e.algorithm.name);t.key=e,Application.crypto.subtle.exportKey('jwk',e).then(function(r){return t.jwk=r,t.Modulus=XmlCore.Convert.FromBase64Url(r.n),t.Exponent=XmlCore.Convert.FromBase64Url(r.e),t.keyUsage=e.usages,Promise.resolve(t)}).then(r,a)})},t.prototype.exportKey=function(e){var t=this;return new Promise(function(r,a){if(t.key)return r(t.key);if(!t.Modulus)throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'RsaKeyValue has no Modulus');var n=XmlCore.Convert.ToBase64Url(t.Modulus);if(!t.Exponent)throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'RsaKeyValue has no Exponent');var o,l=XmlCore.Convert.ToBase64Url(t.Exponent);switch(e.name.toUpperCase()){case RSA_PKCS1.toUpperCase():o='R';break;case RSA_PSS.toUpperCase():o='P';break;default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e.name);}switch(e.hash.name.toUpperCase()){case SHA1:o+='S1';break;case SHA256:o+='S256';break;case SHA384:o+='S384';break;case SHA512:o+='S512';}var m={kty:'RSA',alg:o,n:n,e:l,ext:!0};Application.crypto.subtle.importKey('jwk',m,e,!0,t.keyUsage).then(r,a)})},t.prototype.LoadXml=function(t){e.prototype.LoadXml.call(this,t),this.keyUsage=['verify']},tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.Modulus,prefix:XmlSignature.DefaultPrefix,namespaceURI:XmlSignature.NamespaceURI,required:!0,converter:XmlCore.XmlBase64Converter})],t.prototype,'Modulus',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.Exponent,prefix:XmlSignature.DefaultPrefix,namespaceURI:XmlSignature.NamespaceURI,required:!0,converter:XmlCore.XmlBase64Converter})],t.prototype,'Exponent',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.RSAKeyValue})],t),t}(KeyInfoClause),NAMESPACE_URI$1='http://www.w3.org/2007/05/xmldsig-more#',PREFIX$1='pss',MaskGenerationFunction=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlChildElement({parser:DigestMethod})],t.prototype,'DigestMethod',void 0),tslib_1.__decorate([XmlCore.XmlAttribute({localName:XmlSignature.AttributeNames.Algorithm,defaultValue:'http://www.w3.org/2007/05/xmldsig-more#MGF1'})],t.prototype,'Algorithm',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.MaskGenerationFunction,prefix:PREFIX$1,namespaceURI:NAMESPACE_URI$1})],t),t}(XmlCore.XmlObject),PssAlgorithmParams=function(e){function t(t){var r=e.call(this)||this;return t&&r.FromAlgorithm(t),r}tslib_1.__extends(t,e),r=t,t.FromAlgorithm=function(e){return new r(e)},t.prototype.FromAlgorithm=function(e){this.DigestMethod=new DigestMethod;var t=CryptoConfig.GetHashAlgorithm(e.hash);this.DigestMethod.Algorithm=t.namespaceURI,e.saltLength&&(this.SaltLength=e.saltLength)};var r;return tslib_1.__decorate([XmlCore.XmlChildElement({parser:DigestMethod})],t.prototype,'DigestMethod',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({parser:MaskGenerationFunction})],t.prototype,'MGF',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({converter:XmlCore.XmlNumberConverter,prefix:PREFIX$1,namespaceURI:NAMESPACE_URI$1})],t.prototype,'SaltLength',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({converter:XmlCore.XmlNumberConverter})],t.prototype,'TrailerField',void 0),t=r=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.RSAPSSParams,prefix:PREFIX$1,namespaceURI:NAMESPACE_URI$1})],t),t}(XmlCore.XmlObject),KeyValue=function(e){function t(t){var r=e.call(this)||this;return t&&(r.Value=t),r}return tslib_1.__extends(t,e),Object.defineProperty(t.prototype,'Value',{get:function e(){return this.value},set:function t(e){this.element=null,this.value=e},enumerable:!0,configurable:!0}),t.prototype.importKey=function(e){var t=this;return Promise.resolve().then(function(){switch(e.algorithm.name.toUpperCase()){case RSA_PSS.toUpperCase():case RSA_PKCS1.toUpperCase():return t.Value=new RsaKeyValue,t.Value.importKey(e);case ECDSA.toUpperCase():return t.Value=new EcdsaKeyValue,t.Value.importKey(e);default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e.algorithm.name);}}).then(function(){return t})},t.prototype.exportKey=function(e){var t=this;return Promise.resolve().then(function(){if(!t.Value)throw new XmlCore.XmlError(XmlCore.XE.NULL_REFERENCE);return t.Value.exportKey(e)})},t.prototype.OnGetXml=function(e){if(!this.Value)throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'KeyValue has empty value');var t=this.Value.GetXml();t&&e.appendChild(t)},t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.KeyValue})],t),t}(KeyInfoClause),OID={"2.5.4.3":{short:'CN',long:'CommonName'},"2.5.4.6":{short:'C',long:'Country'},"2.5.4.5":{long:'DeviceSerialNumber'},"0.9.2342.19200300.100.1.25":{short:'DC',long:'DomainComponent'},"1.2.840.113549.1.9.1":{short:'E',long:'EMail'},"2.5.4.42":{short:'G',long:'GivenName'},"2.5.4.43":{short:'I',long:'Initials'},"2.5.4.7":{short:'L',long:'Locality'},"2.5.4.10":{short:'O',long:'Organization'},"2.5.4.11":{short:'OU',long:'OrganizationUnit'},"2.5.4.8":{short:'ST',long:'State'},"2.5.4.9":{short:'Street',long:'StreetAddress'},"2.5.4.4":{short:'SN',long:'SurName'},"2.5.4.12":{short:'T',long:'Title'},"1.2.840.113549.1.9.8":{long:'UnstructuredAddress'},"1.2.840.113549.1.9.2":{long:'UnstructuredName'}},X509Certificate=function(){function e(e){if(this.publicKey=null,e){var t=new Uint8Array(e);this.LoadRaw(t),this.raw=t}}return Object.defineProperty(e.prototype,'SerialNumber',{get:function e(){return this.simpl.serialNumber.valueBlock.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'Issuer',{get:function e(){return this.NameToString(this.simpl.issuer)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'Subject',{get:function e(){return this.NameToString(this.simpl.subject)},enumerable:!0,configurable:!0}),e.prototype.Thumbprint=function(e){return void 0===e&&(e='SHA-1'),Application.crypto.subtle.digest(e,this.raw)},Object.defineProperty(e.prototype,'PublicKey',{get:function e(){return this.publicKey},enumerable:!0,configurable:!0}),e.prototype.GetRaw=function(){return this.raw},e.prototype.exportKey=function(e){var t=this;return Promise.resolve().then(function(){var r={algorithm:e,usages:['verify']};if(r.algorithm.name.toUpperCase()===ECDSA){var a=t.simpl.subjectPublicKeyInfo.toJSON().algorithm.algorithmParams.valueBlock.value;switch(a){case'1.2.840.10045.3.1.7':r.algorithm.namedCurve='P-256';break;case'1.3.132.0.34':r.algorithm.namedCurve='P-384';break;case'1.3.132.0.35':r.algorithm.namedCurve='P-521';break;default:throw new Error('Unsupported named curve OID \''+a+'\'');}}return t.simpl.getPublicKey({algorithm:r}).then(function(e){return t.publicKey=e,e})})},e.prototype.NameToString=function(e,t){void 0===t&&(t=',');var r=[];return e.typesAndValues.forEach(function(e){var t=e.type,a=OID[t.toString()],n=a?a.short:null;r.push((n?n:t)+'='+e.value.valueBlock.value)}),r.join(t+' ')},e.prototype.LoadRaw=function(e){this.raw=new Uint8Array(e);var t=Asn1Js.fromBER(this.raw.buffer);this.simpl=new pkijs.Certificate({schema:t.result})},e}(),X509IssuerSerial=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.X509IssuerName,namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix,required:!0})],t.prototype,'X509IssuerName',void 0),tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.X509SerialNumber,namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix,required:!0})],t.prototype,'X509SerialNumber',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.X509IssuerSerial})],t),t}(XmlSignatureObject);(function(e){e[e.None=0]='None',e[e.EndCertOnly=1]='EndCertOnly',e[e.ExcludeRoot=2]='ExcludeRoot',e[e.WholeChain=3]='WholeChain'})(exports.X509IncludeOption||(exports.X509IncludeOption={}));var KeyInfoX509Data=function(e){function t(t,r){void 0===r&&(r=exports.X509IncludeOption.None);var a=e.call(this)||this;return a.x509crl=null,a.SubjectKeyIdList=[],a.key=null,(t&&(t instanceof Uint8Array?a.AddCertificate(new X509Certificate(t)):t instanceof X509Certificate&&(r===exports.X509IncludeOption.None||r===exports.X509IncludeOption.EndCertOnly?a.AddCertificate(t):r===exports.X509IncludeOption.ExcludeRoot?a.AddCertificatesChainFrom(t,!1):r===exports.X509IncludeOption.WholeChain?a.AddCertificatesChainFrom(t,!0):void 0)),a)}return tslib_1.__extends(t,e),Object.defineProperty(t.prototype,'Key',{get:function e(){return this.key},enumerable:!0,configurable:!0}),t.prototype.importKey=function(){return Promise.reject(new XmlCore.XmlError(XmlCore.XE.METHOD_NOT_SUPPORTED))},t.prototype.exportKey=function(e){var t=this;return Promise.resolve().then(function(){if(t.Certificates.length)return t.Certificates[0].exportKey(e);throw new XmlCore.XmlError(XmlCore.XE.NULL_REFERENCE)}).then(function(e){return t.key=e,e})},Object.defineProperty(t.prototype,'Certificates',{get:function e(){return this.X509CertificateList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'CRL',{get:function e(){return this.x509crl},set:function t(e){this.x509crl=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'IssuerSerials',{get:function e(){return this.IssuerSerialList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'SubjectKeyIds',{get:function e(){return this.SubjectKeyIdList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'SubjectNames',{get:function e(){return this.SubjectNameList},enumerable:!0,configurable:!0}),t.prototype.AddCertificate=function(e){if(!e)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'certificate');this.X509CertificateList||(this.X509CertificateList=[]),this.X509CertificateList.push(e)},t.prototype.AddIssuerSerial=function(e,t){if(null==e)throw new XmlCore.XmlError(XmlCore.XE.PARAM_REQUIRED,'issuerName');null==this.IssuerSerialList&&(this.IssuerSerialList=[]);this.IssuerSerialList.push({issuerName:e,serialNumber:t})},t.prototype.AddSubjectKeyId=function(e){if(this.SubjectKeyIdList&&(this.SubjectKeyIdList=[]),'string'!=typeof e)this.SubjectKeyIdList.push(e);else if(null!=e){var t;t=XmlCore.Convert.FromBase64(e),this.SubjectKeyIdList.push(t)}},t.prototype.AddSubjectName=function(e){null==this.SubjectNameList&&(this.SubjectNameList=[]),this.SubjectNameList.push(e)},t.prototype.GetXml=function(){var e=this.CreateDocument(),t=this.CreateElement(e),r=this.GetPrefix();if(null!=this.IssuerSerialList&&0<this.IssuerSerialList.length&&this.IssuerSerialList.forEach(function(a){var n=e.createElementNS(XmlSignature.NamespaceURI,r+XmlSignature.ElementNames.X509IssuerSerial),o=e.createElementNS(XmlSignature.NamespaceURI,r+XmlSignature.ElementNames.X509IssuerName);o.textContent=a.issuerName,n.appendChild(o);var l=e.createElementNS(XmlSignature.NamespaceURI,r+XmlSignature.ElementNames.X509SerialNumber);l.textContent=a.serialNumber,n.appendChild(l),t.appendChild(n)}),null!=this.SubjectKeyIdList&&0<this.SubjectKeyIdList.length&&this.SubjectKeyIdList.forEach(function(a){var n=e.createElementNS(XmlSignature.NamespaceURI,r+XmlSignature.ElementNames.X509SKI);n.textContent=XmlCore.Convert.ToBase64(a),t.appendChild(n)}),null!=this.SubjectNameList&&0<this.SubjectNameList.length&&this.SubjectNameList.forEach(function(a){var n=e.createElementNS(XmlSignature.NamespaceURI,r+XmlSignature.ElementNames.X509SubjectName);n.textContent=a,t.appendChild(n)}),null!=this.X509CertificateList&&0<this.X509CertificateList.length&&this.X509CertificateList.forEach(function(a){var n=e.createElementNS(XmlSignature.NamespaceURI,r+XmlSignature.ElementNames.X509Certificate);n.textContent=XmlCore.Convert.ToBase64(a.GetRaw()),t.appendChild(n)}),null!=this.x509crl){var a=e.createElementNS(XmlSignature.NamespaceURI,r+XmlSignature.ElementNames.X509CRL);a.textContent=XmlCore.Convert.ToBase64(this.x509crl),t.appendChild(a)}return t},t.prototype.LoadXml=function(t){var r=this;e.prototype.LoadXml.call(this,t),this.IssuerSerialList&&(this.IssuerSerialList=[]),this.SubjectKeyIdList&&(this.SubjectKeyIdList=[]),this.SubjectNameList&&(this.SubjectNameList=[]),this.X509CertificateList&&(this.X509CertificateList=[]),this.x509crl=null;var a=this.GetChildren(XmlSignature.ElementNames.X509IssuerSerial);a&&a.forEach(function(e){var t=XmlSignatureObject.GetChild(e,XmlSignature.ElementNames.X509IssuerName,XmlSignature.NamespaceURI,!0),a=XmlSignatureObject.GetChild(e,XmlSignature.ElementNames.X509SerialNumber,XmlSignature.NamespaceURI,!0);t&&t.textContent&&a&&a.textContent&&r.AddIssuerSerial(t.textContent,a.textContent)}),a=this.GetChildren(XmlSignature.ElementNames.X509SKI),a&&a.forEach(function(e){if(e.textContent){var t=XmlCore.Convert.FromBase64(e.textContent);r.AddSubjectKeyId(t)}}),a=this.GetChildren(XmlSignature.ElementNames.X509SubjectName),null!=a&&a.forEach(function(e){e.textContent&&r.AddSubjectName(e.textContent)}),a=this.GetChildren(XmlSignature.ElementNames.X509Certificate),a&&a.forEach(function(e){if(e.textContent){var t=XmlCore.Convert.FromBase64(e.textContent);r.AddCertificate(new X509Certificate(t))}});var n=this.GetChild(XmlSignature.ElementNames.X509CRL,!1);n&&n.textContent&&(this.x509crl=XmlCore.Convert.FromBase64(n.textContent))},t.prototype.AddCertificatesChainFrom=function(){throw new XmlCore.XmlError(XmlCore.XE.METHOD_NOT_IMPLEMENTED)},t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.X509Data})],t),t}(KeyInfoClause),SPKIData=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.prototype.importKey=function(e){var t=this;return Promise.resolve().then(function(){return Application.crypto.subtle.exportKey('spki',e)}).then(function(r){return t.SPKIexp=new Uint8Array(r),t.Key=e,t})},t.prototype.exportKey=function(e){var t=this;return Promise.resolve().then(function(){return Application.crypto.subtle.importKey('spki',t.SPKIexp,e,!0,['verify'])}).then(function(e){return t.Key=e,e})},tslib_1.__decorate([XmlCore.XmlChildElement({localName:XmlSignature.ElementNames.SPKIexp,namespaceURI:XmlSignature.NamespaceURI,prefix:XmlSignature.DefaultPrefix,required:!0,converter:XmlCore.XmlBase64Converter})],t.prototype,'SPKIexp',void 0),t=tslib_1.__decorate([XmlCore.XmlElement({localName:XmlSignature.ElementNames.SPKIData})],t),t}(KeyInfoClause),SignatureAlgorithms={};SignatureAlgorithms['http://www.w3.org/2000/09/xmldsig#rsa-sha1']=RsaPkcs1Sha1,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#rsa-sha256']=RsaPkcs1Sha256,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#rsa-sha384']=RsaPkcs1Sha384,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#rsa-sha512']=RsaPkcs1Sha512,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha1']=EcdsaSha1,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256']=EcdsaSha256,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha384']=EcdsaSha384,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha512']=EcdsaSha512,SignatureAlgorithms['http://www.w3.org/2000/09/xmldsig#hmac-sha1']=HmacSha1,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#hmac-sha256']=HmacSha256,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#hmac-sha384']=HmacSha384,SignatureAlgorithms['http://www.w3.org/2001/04/xmldsig-more#hmac-sha512']=HmacSha512;var HashAlgorithms={};HashAlgorithms['http://www.w3.org/2000/09/xmldsig#sha1']=Sha1,HashAlgorithms['http://www.w3.org/2001/04/xmlenc#sha256']=Sha256,HashAlgorithms['http://www.w3.org/2001/04/xmldsig-more#sha384']=Sha384,HashAlgorithms['http://www.w3.org/2001/04/xmlenc#sha512']=Sha512;var CryptoConfig=function(){function e(){}return e.CreateFromName=function(e){var t;switch(e){case XmlSignature.AlgorithmNamespaces.XmlDsigBase64Transform:t=new XmlDsigBase64Transform;break;case XmlSignature.AlgorithmNamespaces.XmlDsigC14NTransform:t=new XmlDsigC14NTransform;break;case XmlSignature.AlgorithmNamespaces.XmlDsigC14NWithCommentsTransform:t=new XmlDsigC14NWithCommentsTransform;break;case XmlSignature.AlgorithmNamespaces.XmlDsigEnvelopedSignatureTransform:t=new XmlDsigEnvelopedSignatureTransform;break;case XmlSignature.AlgorithmNamespaces.XmlDsigXPathTransform:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e);case XmlSignature.AlgorithmNamespaces.XmlDsigXsltTransform:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e);case XmlSignature.AlgorithmNamespaces.XmlDsigExcC14NTransform:t=new XmlDsigExcC14NTransform;break;case XmlSignature.AlgorithmNamespaces.XmlDsigExcC14NWithCommentsTransform:t=new XmlDsigExcC14NWithCommentsTransform;break;case XmlSignature.AlgorithmNamespaces.XmlDecryptionTransform:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e);default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e);}return t},e.CreateSignatureAlgorithm=function(e){var t=SignatureAlgorithms[e.Algorithm]||null;if(t)return new t;if(e.Algorithm===RSA_PSS_WITH_PARAMS_NAMESPACE){var r;if(e.Any.Some(function(e){return e instanceof PssAlgorithmParams&&(r=e),!!r}),r)switch(r.DigestMethod.Algorithm){case SHA1_NAMESPACE:return new RsaPssSha1(r.SaltLength);case SHA256_NAMESPACE:return new RsaPssSha256(r.SaltLength);case SHA384_NAMESPACE:return new RsaPssSha384(r.SaltLength);case SHA512_NAMESPACE:return new RsaPssSha512(r.SaltLength);}throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Cannot get params for RSA-PSS algoriithm')}throw new Error('signature algorithm \''+e.Algorithm+'\' is not supported')},e.CreateHashAlgorithm=function(e){var t=HashAlgorithms[e];if(t)return new t;throw new Error('hash algorithm \''+e+'\' is not supported')},e.GetHashAlgorithm=function(e){var t='string'==typeof e?{name:e}:e;switch(t.name.toUpperCase()){case SHA1:return new Sha1;case SHA256:return new Sha256;case SHA384:return new Sha384;case SHA512:return new Sha512;default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,t.name);}},e.GetSignatureAlgorithm=function(e){'string'==typeof e.hash&&(e.hash={name:e.hash});var t=e.hash.name;if(!t)throw new Error('Signing algorithm doesn\'t have name for hash');var r;switch(e.name.toUpperCase()){case RSA_PKCS1.toUpperCase():switch(t.toUpperCase()){case SHA1:r=new RsaPkcs1Sha1;break;case SHA256:r=new RsaPkcs1Sha256;break;case SHA384:r=new RsaPkcs1Sha384;break;case SHA512:r=new RsaPkcs1Sha512;break;default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e.name+':'+t);}break;case RSA_PSS.toUpperCase():var a=e.saltLength;switch(t.toUpperCase()){case SHA1:r=new RsaPssSha1(a);break;case SHA256:r=new RsaPssSha256(a);break;case SHA384:r=new RsaPssSha384(a);break;case SHA512:r=new RsaPssSha512(a);break;default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e.name+':'+t);}break;case ECDSA:switch(t.toUpperCase()){case SHA1:r=new EcdsaSha1;break;case SHA256:r=new EcdsaSha256;break;case SHA384:r=new EcdsaSha384;break;case SHA512:r=new EcdsaSha512;break;default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e.name+':'+t);}break;case HMAC:switch(t.toUpperCase()){case SHA1:r=new HmacSha1;break;case SHA256:r=new HmacSha256;break;case SHA384:r=new HmacSha384;break;case SHA512:r=new HmacSha512;break;default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e.name+':'+t);}break;default:throw new XmlCore.XmlError(XmlCore.XE.ALGORITHM_NOT_SUPPORTED,e.name);}return r},e}(),SignedXml=function(){function e(e){if(this.signature=new Signature,e&&e.nodeType===XmlCore.XmlNodeType.Document)this.document=e;else if(e&&e.nodeType===XmlCore.XmlNodeType.Element){var t=new XMLSerializer().serializeToString(e);this.document=new DOMParser().parseFromString(t,XmlCore.APPLICATION_XML)}}return Object.defineProperty(e.prototype,'XmlSignature',{get:function e(){return this.signature},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'Signature',{get:function e(){return this.XmlSignature.SignatureValue},enumerable:!0,configurable:!0}),e.prototype.Sign=function(e,t,r,a){var n,o,l=this;return Promise.resolve().then(function(){var r=XmlCore.assign({},t.algorithm,e);return n=CryptoConfig.GetSignatureAlgorithm(r),l.ApplySignOptions(l.XmlSignature,e,t,a)}).then(function(){return o=l.XmlSignature.SignedInfo,l.DigestReferences(r.documentElement)}).then(function(){if(o.SignatureMethod.Algorithm=n.namespaceURI,RSA_PSS.toUpperCase()===e.name.toUpperCase()){var a=XmlCore.assign({},t.algorithm,e);'string'==typeof a.hash&&(a.hash={name:a.hash});var m=new PssAlgorithmParams(a);l.XmlSignature.SignedInfo.SignatureMethod.Any.Add(m)}else if(HMAC.toUpperCase()===e.name.toUpperCase()){var i=0,s=t.algorithm;switch(s.hash.name.toUpperCase()){case SHA1:i=s.length||160;break;case SHA256:i=s.length||256;break;case SHA384:i=s.length||384;break;case SHA512:i=s.length||512;}l.XmlSignature.SignedInfo.SignatureMethod.HMACOutputLength=i}var p=l.TransformSignedInfo(r);return n.Sign(p,t,e)}).then(function(e){return l.Key=t,l.XmlSignature.SignatureValue=new Uint8Array(e),l.document=r,l.XmlSignature})},e.prototype.Verify=function(e){var t=this;return Promise.resolve().then(function(){var e=t.document;if(!(e&&e.documentElement))throw new XmlCore.XmlError(XmlCore.XE.NULL_PARAM,'SignedXml','document');return t.ValidateReferences(e.documentElement)}).then(function(r){if(r){var a=Promise.resolve([]);return a=e?a.then(function(){return[e]}):a.then(function(){return t.GetPublicKeys()}),a.then(function(e){return t.ValidateSignatureValue(e)})}return!1})},e.prototype.GetXml=function(){return this.signature.GetXml()},e.prototype.LoadXml=function(e){this.signature=Signature.LoadXml(e)},e.prototype.toString=function(){var e=this.XmlSignature,t=e.SignedInfo.References&&e.SignedInfo.References.Some(function(e){return e.Transforms&&e.Transforms.Some(function(e){return e instanceof XmlDsigEnvelopedSignatureTransform})});if(t){var r=this.document.documentElement.cloneNode(!0),a=this.XmlSignature.GetXml();if(!a)throw new XmlCore.XmlError(XmlCore.XE.XML_EXCEPTION,'Cannot get Xml element from Signature');var n=a.cloneNode(!0);return r.appendChild(n),new XMLSerializer().serializeToString(r)}return this.XmlSignature.toString()},e.prototype.GetPublicKeys=function(){var e=this,t=[];return Promise.resolve().then(function(){var r=e.XmlSignature.KeyInfo.GetIterator(),a=[];return r.forEach(function(r){var n=CryptoConfig.CreateSignatureAlgorithm(e.XmlSignature.SignedInfo.SignatureMethod);r instanceof KeyInfoX509Data?r.Certificates.forEach(function(e){a.push(e.exportKey(n.algorithm).then(function(e){t.push(e)}))}):a.push(r.exportKey(n.algorithm).then(function(e){t.push(e)}))}),Promise.all(a)}).then(function(){return t})},e.prototype.GetSignatureNamespaces=function(){var e={};return this.XmlSignature.NamespaceURI&&(e[this.XmlSignature.Prefix||'']=this.XmlSignature.NamespaceURI),e},e.prototype.CopyNamespaces=function(e,t,r){this.InjectNamespaces(SelectRootNamespaces(e),t,r)},e.prototype.InjectNamespaces=function(e,t,r){for(var a in e){var n=e[a];r&&''==a||t.setAttribute('xmlns'+(a?':'+a:''),n)}},e.prototype.DigestReference=function(e,t){var r=this;return Promise.resolve().then(function(){if(t.Uri){var a;if(!t.Uri.indexOf('#xpointer')){var n=t.Uri;n=n.substring(9).replace(/[\r\n\t\s]/g,''),n=2>n.length||'('!==n[0]||')'!==n[n.length-1]?'':n.substring(1,n.length-1),6<n.length&&0===n.indexOf('id(')&&')'===n[n.length-1]&&(a=n.substring(4,n.length-2))}else'#'===t.Uri[0]&&(a=t.Uri.substring(1));if(a){var o=null,l=[r.XmlSignature.KeyInfo.GetXml()];r.XmlSignature.ObjectList.ForEach(function(e){l.push(e.GetXml())});for(var m,i=0,s=l;i<s.length;i++)if(m=s[i],m&&(o=findById(m,a),o)){var p=o.cloneNode(!0);if(r.CopyNamespaces(e,p,!1),r.Parent){var d=r.Parent instanceof XmlCore.XmlObject?r.Parent.GetXml():r.Parent;r.CopyNamespaces(d,p,!0)}r.CopyNamespaces(o,p,!1),r.InjectNamespaces(r.GetSignatureNamespaces(),p,!0),e=p;break}if(!o&&e&&(o=XmlCore.XmlObject.GetElementById(e,a),o)){var p=o.cloneNode(!0);r.CopyNamespaces(o,p,!1),r.CopyNamespaces(e,p,!1),e=p}if(null==o)throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,'Cannot get object by reference: '+a)}}var u=null;if(t.Transforms&&t.Transforms.Count)u=r.ApplyTransforms(t.Transforms,e);else if(t.Uri&&'#'!==t.Uri[0])u=new XMLSerializer().serializeToString(e.ownerDocument);else{var c=new XmlDsigC14NTransform;c.LoadInnerXml(e),u=c.GetOutput()}if(!t.DigestMethod.Algorithm)throw new XmlCore.XmlError(XmlCore.XE.NULL_PARAM,'Reference','DigestMethod');var h=CryptoConfig.CreateHashAlgorithm(t.DigestMethod.Algorithm);return h.Digest(u)})},e.prototype.DigestReferences=function(e){var t=this;return Promise.resolve().then(function(){var r=t.XmlSignature.SignedInfo.References.Map(function(r){return r.DigestMethod.Algorithm||(r.DigestMethod.Algorithm=new Sha256().namespaceURI),t.DigestReference(e,r,!1).then(function(e){r.DigestValue=e})}).GetIterator();return Promise.all(r)})},e.prototype.TransformSignedInfo=function(e){var r=CryptoConfig.CreateFromName(this.XmlSignature.SignedInfo.CanonicalizationMethod.Algorithm),t=this.XmlSignature.SignedInfo.GetXml();if(!t)throw new XmlCore.XmlError(XmlCore.XE.XML_EXCEPTION,'Cannot get Xml element from SignedInfo');var a=t.cloneNode(!0);if(this.CopyNamespaces(t,a,!1),e&&(e.nodeType===XmlCore.XmlNodeType.Document?this.CopyNamespaces(e.documentElement,a,!1):this.CopyNamespaces(e,a,!1)),this.Parent){var n=this.Parent instanceof XmlCore.XmlObject?this.Parent.GetXml():this.Parent;n&&this.CopyNamespaces(n,a,!1)}var o=XmlCore.SelectNamespaces(t);for(var l in o){var m=o[l];l!==a.prefix&&a.setAttribute('xmlns'+(l?':'+l:''),m)}r.LoadInnerXml(a);var i=r.GetOutput();return i},e.prototype.ResolveFilterTransform=function(e){var t=e.split(' ');if(3!=t.length)throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC_TRANSFORM_FILTER,e);var r=t[1].trim(),a=t[2].trim();return new XmlDsigDisplayFilterTransform({Filter:r,XPath:a})},e.prototype.ResolveTransform=function(e){switch(e){case'enveloped':return new XmlDsigEnvelopedSignatureTransform;case'c14n':return new XmlDsigC14NTransform;case'c14n-com':return new XmlDsigC14NWithCommentsTransform;case'exc-c14n':return new XmlDsigExcC14NTransform;case'exc-c14n-com':return new XmlDsigExcC14NWithCommentsTransform;case'base64':return new XmlDsigBase64Transform;default:throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC_UNKNOWN_TRANSFORM,e);}},e.prototype.ApplyTransforms=function(e,t){var r=null;if(e.Sort(function(e,t){return e instanceof XmlDsigDisplayFilterTransform?-1:t instanceof XmlDsigDisplayFilterTransform?1:t instanceof XmlDsigEnvelopedSignatureTransform?-1:t instanceof XmlDsigEnvelopedSignatureTransform?1:0}).ForEach(function(e){e instanceof XmlDsigC14NWithCommentsTransform&&(e=new XmlDsigC14NTransform),e instanceof XmlDsigExcC14NWithCommentsTransform&&(e=new XmlDsigExcC14NTransform),e.LoadInnerXml(t),r=e.GetOutput()}),1===e.Count&&e.Item(0)instanceof XmlDsigEnvelopedSignatureTransform){var a=new XmlDsigC14NTransform;a.LoadInnerXml(t),r=a.GetOutput()}return r},e.prototype.ApplySignOptions=function(e,t,r,a){var n=this;return void 0===a&&(a={}),Promise.resolve().then(function(){if(a.id&&(n.XmlSignature.Id=a.id),a.keyValue&&r.algorithm.name.toUpperCase()!==HMAC){e.KeyInfo||(e.KeyInfo=new KeyInfo);var t=e.KeyInfo,o=new KeyValue;return t.Add(o),o.importKey(a.keyValue)}return Promise.resolve()}).then(function(){if(a.x509){e.KeyInfo||(e.KeyInfo=new KeyInfo);var t=e.KeyInfo;a.x509.forEach(function(e){var r=XmlCore.Convert.FromBase64(e),a=new KeyInfoX509Data(r);t.Add(a)})}return Promise.resolve()}).then(function(){if(a.references&&a.references.forEach(function(t){var r=new Reference;t.id&&(r.Id=t.id),null!==t.uri&&void 0!==t.uri&&(r.Uri=t.uri),t.type&&(r.Type=t.type);var a=CryptoConfig.GetHashAlgorithm(t.hash);if(r.DigestMethod.Algorithm=a.namespaceURI,t.transforms&&t.transforms.length){var o=new Transforms;t.transforms.forEach(function(e){e.startsWith('filter')?o.Add(n.ResolveFilterTransform(e)):o.Add(n.ResolveTransform(e))}),r.Transforms=o}e.SignedInfo.References||(e.SignedInfo.References=new References),e.SignedInfo.References.Add(r)}),!e.SignedInfo.References.Count){var t=new Reference;e.SignedInfo.References.Add(t)}return Promise.resolve()})},e.prototype.ValidateReferences=function(e){var t=this;return Promise.resolve().then(function(){return Promise.all(t.XmlSignature.SignedInfo.References.Map(function(r){return t.DigestReference(e,r,!1).then(function(e){var t=XmlCore.Convert.ToBase64(e),a=XmlCore.Convert.ToString(r.DigestValue,'base64');if(t!==a){var n='Invalid digest for uri \''+r.Uri+'\'. Calculated digest is '+t+' but the xml to validate supplies digest '+a;throw new XmlCore.XmlError(XmlCore.XE.CRYPTOGRAPHIC,n)}return Promise.resolve(!0)})}).GetIterator())}).then(function(){return!0})},e.prototype.ValidateSignatureValue=function(e){var t,r,a=this;return Promise.resolve().then(function(){r=a.TransformSignedInfo(a.document),t=CryptoConfig.CreateSignatureAlgorithm(a.XmlSignature.SignedInfo.SignatureMethod);var n=Promise.resolve(!1);return e.forEach(function(e){n=n.then(function(n){return n?Promise.resolve(n):t.Verify(r,e,a.Signature)})}),n})},e}();function findById(e,t){if(e.nodeType!==XmlCore.XmlNodeType.Element)return null;if(e.hasAttribute('Id')&&e.getAttribute('Id')===t)return e;if(e.childNodes&&e.childNodes.length)for(var r,a=0;a<e.childNodes.length;a++)if(r=findById(e.childNodes[a],t),r)return r;return null}function addNamespace(e,t,r){t in e||(e[t]=r)}function _SelectRootNamespaces(e,t){if(void 0===t&&(t={}),e&&e.nodeType===XmlCore.XmlNodeType.Element){var r=e;r.namespaceURI&&'http://www.w3.org/XML/1998/namespace'!==r.namespaceURI&&addNamespace(t,r.prefix?r.prefix:'',e.namespaceURI);for(var a,n=0;n<r.attributes.length;n++)a=r.attributes.item(n),a&&'xmlns'===a.prefix&&addNamespace(t,a.localName?a.localName:'',a.value);e.parentNode&&_SelectRootNamespaces(e.parentNode,t)}}function SelectRootNamespaces(e){var t={};return _SelectRootNamespaces(e,t),t}exports.Select=XmlCore.Select,exports.Parse=XmlCore.Parse,exports.Stringify=XmlCore.Stringify,exports.Application=Application,exports.XmlCanonicalizer=XmlCanonicalizer,exports.CryptoConfig=CryptoConfig,exports.XmlSignature=XmlSignature,exports.XmlSignatureObject=XmlSignatureObject,exports.XmlSignatureCollection=XmlSignatureCollection,exports.CanonicalizationMethod=CanonicalizationMethod,exports.DataObject=DataObject,exports.DataObjects=DataObjects,exports.DigestMethod=DigestMethod,exports.KeyInfo=KeyInfo,exports.Reference=Reference,exports.References=References,exports.Signature=Signature,exports.SignatureMethodOther=SignatureMethodOther,exports.SignatureMethod=SignatureMethod,exports.SignedInfo=SignedInfo,exports.XmlDsigBase64Transform=XmlDsigBase64Transform,exports.XmlDsigC14NTransform=XmlDsigC14NTransform,exports.XmlDsigC14NWithCommentsTransform=XmlDsigC14NWithCommentsTransform,exports.XmlDsigEnvelopedSignatureTransform=XmlDsigEnvelopedSignatureTransform,exports.XmlDsigExcC14NTransform=XmlDsigExcC14NTransform,exports.XmlDsigExcC14NWithCommentsTransform=XmlDsigExcC14NWithCommentsTransform,exports.XmlDsigDisplayFilterTransform=XmlDsigDisplayFilterTransform,exports.Transform=Transform,exports.Transforms=Transforms,exports.X509Certificate=X509Certificate,exports.KeyInfoClause=KeyInfoClause,exports.KeyValue=KeyValue,exports.EcdsaPublicKey=EcdsaPublicKey,exports.NamedCurve=NamedCurve,exports.DomainParameters=DomainParameters,exports.EcdsaKeyValue=EcdsaKeyValue,exports.RsaKeyValue=RsaKeyValue,exports.MaskGenerationFunction=MaskGenerationFunction,exports.PssAlgorithmParams=PssAlgorithmParams,exports.X509IssuerSerial=X509IssuerSerial,exports.KeyInfoX509Data=KeyInfoX509Data,exports.SPKIData=SPKIData,exports.SelectRootNamespaces=SelectRootNamespaces,exports.SignedXml=SignedXml;
